{% extends 'base.html' %}
{% block title %}{{ page_title or 'Medusa – Scraper' }}{% endblock %}

{% block main %}
{% macro render_scraper_panel(provider, status, settings, panel_id, heading, mode, helper_text=None, start_page=None) %}
    {% set progress_value = status.get('progress', 0.0) %}
    {% set status_next = status.get('next_page') or settings.get('next_page') %}
    {% set status_last = status.get('last_page') or (settings.get('last_page') if settings.get('last_page') else None) %}
    {% set initial_state = 'Bereit' %}
    {% if status.get('error') %}
        {% set initial_state = 'Fehler' %}
    {% elif status.get('running') %}
        {% set initial_state = 'Läuft' %}
    {% elif status.get('processed_links') %}
        {% set initial_state = 'Fertig' %}
    {% endif %}
    {% set initial_message = status.get('message') or 'Bereit.' %}
    {% set initial_pages = 'Noch nicht gestartet' %}
    {% if status.get('running') and status.get('current_page') is not none %}
        {% set initial_pages = 'Seite ' ~ status.get('current_page') %}
        {% if status_next and status_next != status.get('current_page') %}
            {% set initial_pages = initial_pages ~ ' · nächste: ' ~ status_next %}
        {% endif %}
        {% if status.get('processed_pages') %}
            {% set initial_pages = initial_pages ~ ' · ' ~ status.get('processed_pages') ~ ' abgeschlossen' %}
        {% endif %}
    {% elif status_last %}
        {% set initial_pages = 'Letzte: ' ~ status_last %}
        {% if status_next %}
            {% set initial_pages = initial_pages ~ ' · nächste: ' ~ status_next %}
        {% endif %}
    {% elif status_next %}
        {% set initial_pages = 'Bereit ab Seite ' ~ status_next %}
    {% endif %}

    <section
        class="surface scraper-status"
        data-scraper-panel
        data-provider="{{ provider.name }}"
        data-scraper-id="{{ panel_id }}"
        data-scraper-mode="{{ mode }}"
        data-initial-status='{{ status|tojson }}'
        {% if start_page is not none -%}
        data-start-page="{{ start_page }}"
        {%- endif %}
    >
        <div class="scraper-status__header">
            <div>
                <h2>{{ heading }}</h2>
                <p class="scraper-status__message" data-role="scraper-message" aria-live="polite">
                    {{ initial_message }}
                </p>
                {% if helper_text %}
                <p class="scraper-status__description">{{ helper_text }}</p>
                {% endif %}
            </div>
            <div class="scraper-status__actions">
                <span class="scraper-status__state" data-role="scraper-state">{{ initial_state }}</span>
                <button
                    type="button"
                    class="chip"
                    data-action="start-scraper"
                    data-provider="{{ provider.name }}"
                >
                    <span class="material-symbols-outlined" aria-hidden="true">play_arrow</span>
                    <span>Scraper starten</span>
                </button>
            </div>
        </div>

        <div class="scraper-status__body">
            <div class="scraper-status__progress">
                <div class="scraper-status__progress-bar">
                    <div
                        class="scraper-status__progress-value"
                        data-role="scraper-progress-bar"
                        style="width: {{ '%.1f'|format(progress_value) }}%;"
                    ></div>
                </div>
                <div class="scraper-status__progress-meta">
                    <span data-role="scraper-progress-label">{{ '%.1f'|format(progress_value) }}%</span>
                    <span data-role="scraper-updated">
                        {% if status.get('last_update') %}
                            Aktualisiert: {{ status.get('last_update') }}
                        {% else %}
                            Noch keine Aktivität
                        {% endif %}
                    </span>
                </div>
            </div>

            <dl class="scraper-status__metrics">
                <div>
                    <dt>Seiten</dt>
                    <dd data-role="scraper-pages">{{ initial_pages }}</dd>
                </div>
                <div>
                    <dt>Links gespeichert</dt>
                    <dd data-role="scraper-links">{{ status.get('processed_links', 0) }}</dd>
                </div>
                <div>
                    <dt>Letzter Titel</dt>
                    <dd data-role="scraper-title">{{ status.get('last_title') or '–' }}</dd>
                </div>
            </dl>
        </div>

        <div class="scraper-status__log">
            <div class="scraper-status__log-header">
                <h3>Aktivitätsprotokoll</h3>
                <button
                    type="button"
                    class="chip chip--subtle"
                    data-action="refresh-scraper"
                    data-provider="{{ provider.name }}"
                >
                    <span class="material-symbols-outlined" aria-hidden="true">refresh</span>
                    <span>Aktualisieren</span>
                </button>
            </div>
            <ul class="scraper-status__log-list" data-role="scraper-log">
                {% if status.get('log') %}
                    {% for entry in status.get('log')|reverse %}
                        <li class="scraper-status__log-item" data-level="{{ entry.level }}">
                            <span class="scraper-status__log-time">{{ entry.timestamp }}</span>
                            <span class="scraper-status__log-text">{{ entry.message }}</span>
                        </li>
                    {% endfor %}
                {% else %}
                    <li class="scraper-status__log-item is-empty">Noch keine Aktivitäten.</li>
                {% endif %}
            </ul>
        </div>
    </section>
{% endmacro %}

<section class="surface page-header">
    <div>
        <h1>Scraper</h1>
        <p class="section-subtitle">Verwalte Links, die über die Scraper gesammelt wurden.</p>
    </div>
</section>

<section class="surface scraper-status" id="scraperGlobalPanel">
    <div class="scraper-status__header">
        <div>
            <h2>Alle Scraper</h2>
            <p class="scraper-status__message">Starte alle verfügbaren Scraper gleichzeitig.</p>
        </div>
        <div class="scraper-status__actions">
            <button type="button" class="chip" id="scraperStartAll">
                <span class="material-symbols-outlined" aria-hidden="true">play_arrow</span>
                <span>Alle Scraper starten</span>
            </button>
        </div>
    </div>
</section>

{% for provider in movie_scraper_providers %}
    {% set status = scraper_statuses.get(provider.name, {}) %}
    {% set settings = scraper_settings.get(provider.name, {}) %}
    {{ render_scraper_panel(provider, status, settings, provider.name, provider.label ~ ' Scraper', 'movies') }}
{% endfor %}

{% if series_scraper_providers %}
<section class="surface page-header">
    <div>
        <h2>Serien-Scraper</h2>
        <p class="section-subtitle">Starte zusätzliche Läufe für Anbieter mit Serienunterstützung.</p>
    </div>
</section>
    {% for provider in series_scraper_providers %}
        {% set status = scraper_statuses.get(provider.name, {}) %}
        {% set settings = scraper_settings.get(provider.name, {}) %}
        {% set helper = 'Beginnt automatisch bei Seite 1, wenn verfügbar, und lädt Filme & Serien.' %}
        {{ render_scraper_panel(provider, status, settings, provider.name ~ '-series', provider.label ~ ' Serien-Scraper', 'series', helper, 1) }}
    {% endfor %}
{% endif %}

<section class="surface">
    <div class="scraper-grid">
        {% if scraped %}
            {% for link in scraped %}
            <div class="scraper-card" data-movie-id="{{ link.movie.id }}" role="button" tabindex="0">
                <div class="scraper-card__info">
                    <h4>{{ link.movie.title }}</h4>
                    <p>{{ link.source_name }} · {{ link.mirror_info or 'Mirror' }}</p>
                </div>
                <button type="button" class="chip view-detail" data-movie-id="{{ link.movie.id }}">
                    <span class="material-symbols-outlined" aria-hidden="true">open_in_new</span>
                    <span>Details</span>
                </button>
            </div>
            {% endfor %}
        {% else %}
            <p class="empty large">Noch keine gescrapten Links vorhanden.</p>
        {% endif %}
    </div>
</section>
{% endblock %}
