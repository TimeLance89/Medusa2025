{% extends 'base.html' %}
{% block title %}{{ page_title or 'Medusa – Scraper' }}{% endblock %}

{% block main %}
{% macro render_scraper_panel(provider, status, settings, panel_id, heading, mode, start_page=None) %}
    {% set progress_value = status.get('progress', 0.0) %}
    {% set status_next = status.get('next_page') or settings.get('next_page') %}
    {% set status_last = status.get('last_page') or (settings.get('last_page') if settings.get('last_page') else None) %}
    {% set initial_state = 'Bereit' %}
    {% if status.get('error') %}
        {% set initial_state = 'Fehler' %}
    {% elif status.get('running') %}
        {% set initial_state = 'Läuft' %}
    {% elif status.get('processed_links') %}
        {% set initial_state = 'Fertig' %}
    {% endif %}
    {% set initial_message = status.get('message') or 'Bereit.' %}
    {% set initial_pages = 'Noch nicht gestartet' %}
    {% if status.get('running') and status.get('current_page') is not none %}
        {% set initial_pages = 'Seite ' ~ status.get('current_page') %}
        {% if status_next and status_next != status.get('current_page') %}
            {% set initial_pages = initial_pages ~ ' · nächste: ' ~ status_next %}
        {% endif %}
        {% if status.get('processed_pages') %}
            {% set initial_pages = initial_pages ~ ' · ' ~ status.get('processed_pages') ~ ' abgeschlossen' %}
        {% endif %}
    {% elif status_last %}
        {% set initial_pages = 'Letzte: ' ~ status_last %}
        {% if status_next %}
            {% set initial_pages = initial_pages ~ ' · nächste: ' ~ status_next %}
        {% endif %}
    {% elif status_next %}
        {% set initial_pages = 'Bereit ab Seite ' ~ status_next %}
    {% endif %}

    <section
        class="surface scraper-status scraper-card"
        data-scraper-panel
        data-provider="{{ provider.name }}"
        data-scraper-id="{{ panel_id }}"
        data-scraper-mode="{{ mode }}"
        data-initial-status='{{ status|tojson }}'
        {% if start_page is not none -%}
        data-start-page="{{ start_page }}"
        {%- endif %}
    >
        <header class="scraper-card__header">
            <div>
                <p class="scraper-card__eyebrow">{{ heading }}</p>
                <h3>{{ provider.label }}</h3>
            </div>
            <div class="scraper-card__actions">
                <span class="scraper-status__state" data-role="scraper-state">{{ initial_state }}</span>
                <button
                    type="button"
                    class="chip"
                    data-action="start-scraper"
                    data-provider="{{ provider.name }}"
                >
                    <span class="material-symbols-outlined" aria-hidden="true">play_arrow</span>
                    <span>Scraper starten</span>
                </button>
            </div>
        </header>

        <div class="scraper-card__body">
            <div class="scraper-card__status">
                <p class="scraper-status__message" data-role="scraper-message" aria-live="polite">
                    {{ initial_message }}
                </p>
                <div class="scraper-status__progress">
                    <div class="scraper-status__progress-bar">
                        <div
                            class="scraper-status__progress-value"
                            data-role="scraper-progress-bar"
                            style="width: {{ '%.1f'|format(progress_value) }}%;"
                        ></div>
                    </div>
                    <div class="scraper-status__progress-meta">
                        <span data-role="scraper-progress-label">{{ '%.1f'|format(progress_value) }}%</span>
                        <span data-role="scraper-updated">
                            {% if status.get('last_update') %}
                                Aktualisiert: {{ status.get('last_update') }}
                            {% else %}
                                Noch keine Aktivität
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>

            <dl class="scraper-status__metrics">
                <div>
                    <dt>Seiten</dt>
                    <dd data-role="scraper-pages">{{ initial_pages }}</dd>
                </div>
                <div>
                    <dt>Links gespeichert</dt>
                    <dd data-role="scraper-links">{{ status.get('processed_links', 0) }}</dd>
                </div>
                <div>
                    <dt>Letzter Titel</dt>
                    <dd data-role="scraper-title">{{ status.get('last_title') or '–' }}</dd>
                </div>
            </dl>
        </div>

        <footer class="scraper-card__footer">
            <details class="scraper-log">
                <summary>
                    <span class="material-symbols-outlined" aria-hidden="true">list</span>
                    <span>Aktivitätsprotokoll</span>
                </summary>
                <div class="scraper-log__body">
                    <button
                        type="button"
                        class="chip chip--subtle"
                        data-action="refresh-scraper"
                        data-provider="{{ provider.name }}"
                    >
                        <span class="material-symbols-outlined" aria-hidden="true">refresh</span>
                        <span>Aktualisieren</span>
                    </button>
                    <ul class="scraper-status__log-list" data-role="scraper-log">
                        {% if status.get('log') %}
                            {% for entry in status.get('log')|reverse %}
                                <li class="scraper-status__log-item" data-level="{{ entry.level }}">
                                    <span class="scraper-status__log-time">{{ entry.timestamp }}</span>
                                    <span class="scraper-status__log-text">{{ entry.message }}</span>
                                </li>
                            {% endfor %}
                        {% else %}
                            <li class="scraper-status__log-item is-empty">Noch keine Aktivitäten.</li>
                        {% endif %}
                    </ul>
                </div>
            </details>
        </footer>
    </section>
{% endmacro %}

{% set all_providers = scraper_providers if scraper_providers else movie_scraper_providers + series_scraper_providers %}
{% set summary = namespace(running=0, completed=0) %}
{% for provider in all_providers %}
    {% set status = scraper_statuses.get(provider.name, {}) %}
    {% if status.get('running') %}
        {% set summary.running = summary.running + 1 %}
    {% elif status.get('processed_links') %}
        {% set summary.completed = summary.completed + 1 %}
    {% endif %}
{% endfor %}

{% set recent_entries = scraper_recent_entries or [] %}
{% set total_links_value = scraper_recent_total|default(None) %}
{% set total_links = total_links_value if total_links_value is not none else recent_entries|length %}
{% set total_providers = all_providers|length %}
{% set total_movie_providers = movie_scraper_providers|length %}
{% set total_series_providers = series_scraper_providers|length %}

<section class="surface page-header page-header--split">
    <div class="page-header__content">
        <h1>Scraper</h1>
        <p class="section-subtitle">Kompakter Überblick über alle Scraper-Läufe und zuletzt importierte Links.</p>
        <div class="page-header__stats">
            <span><strong>{{ total_providers }}</strong> aktive Anbieter</span>
            <span><strong>{{ total_movie_providers }}</strong> Film-Scraper</span>
            {% if total_series_providers %}
            <span><strong>{{ total_series_providers }}</strong> Serien-Scraper</span>
            {% endif %}
            <span><strong>{{ total_links }}</strong> gespeicherte Links</span>
        </div>
    </div>
    <div class="page-header__actions page-header__actions--stacked">
        <button type="button" class="chip chip--primary" id="scraperStartAll">
            <span class="material-symbols-outlined" aria-hidden="true">play_arrow</span>
            <span>Alle Scraper starten</span>
        </button>
        <p class="page-header__hint">
            {{ summary.running }} Läufe aktiv · {{ summary.completed }} zuletzt abgeschlossen
        </p>
    </div>
</section>

<section class="scraper-layout">
    <div class="surface scraper-summary" id="scraperGlobalPanel">
        <header class="scraper-summary__header">
            <div>
                <h2>Überblick</h2>
                <p class="scraper-summary__description">Starte alle verfügbaren Film-Scraper gesammelt oder behalte den Fortschritt einzelner Läufe im Blick.</p>
            </div>
        </header>
        <dl class="scraper-summary__metrics">
            <div>
                <dt>Aktive Scraper</dt>
                <dd>{{ summary.running }}</dd>
            </div>
            <div>
                <dt>Abgeschlossene Läufe</dt>
                <dd>{{ summary.completed }}</dd>
            </div>
            <div>
                <dt>Film-Scraper</dt>
                <dd>{{ total_movie_providers }}</dd>
            </div>
            <div>
                <dt>Serien-Scraper</dt>
                <dd>{{ total_series_providers }}</dd>
            </div>
            <div>
                <dt>Gespeicherte Links</dt>
                <dd>{{ total_links }}</dd>
            </div>
        </dl>
    </div>

    <div class="scraper-panels">
        {% if movie_scraper_providers %}
            {% for provider in movie_scraper_providers %}
                {% set status = scraper_statuses.get(provider.name, {}) %}
                {% set settings = scraper_settings.get(provider.name, {}) %}
                {{ render_scraper_panel(provider, status, settings, provider.name, 'Film-Scraper', 'movies') }}
            {% endfor %}
        {% else %}
            <p class="empty large">Keine Scraper-Anbieter verfügbar.</p>
        {% endif %}
    </div>
</section>

{% if series_scraper_providers %}
<section class="surface scraper-group">
    <header class="section-head">
        <div>
            <h2>Serien-Scraper</h2>
            <p class="section-subtitle">Automatischer Import neuer Episoden-Streams.</p>
        </div>
    </header>
    <div class="scraper-panels">
        {% for provider in series_scraper_providers %}
            {% set status = scraper_statuses.get(provider.name, {}) %}
            {% set settings = scraper_settings.get(provider.name, {}) %}
            {{ render_scraper_panel(provider, status, settings, provider.name, 'Serien-Scraper', 'series') }}
        {% endfor %}
    </div>
</section>
{% endif %}

<section class="surface scraper-results">
    <header class="scraper-results__header">
        <div>
            <h2>Zuletzt gespeicherte Links</h2>
            <p class="scraper-results__description">Direkter Zugriff auf die letzten Einträge aus den Scraper-Läufen.</p>
        </div>
    </header>

    {% if recent_entries %}
    <ul class="scraper-results__list">
        {% for entry in recent_entries %}
            {% set is_series = entry.content_type == 'series' %}
            {% set movie = entry.movie %}
            {% set series = entry.series %}
            {% set season_number = entry.season_number %}
            {% set episode_number = entry.episode_number %}
            {% set subtitle = '' %}
            {% if is_series %}
                {% if season_number is not none and episode_number is not none %}
                    {% set subtitle = 'Staffel ' ~ season_number ~ ' · Episode ' ~ '%02d' % episode_number %}
                {% elif season_number is not none %}
                    {% set subtitle = 'Staffel ' ~ season_number %}
                {% endif %}
                {% if entry.episode_title %}
                    {% if subtitle %}
                        {% set subtitle = subtitle ~ ' – ' ~ entry.episode_title %}
                    {% else %}
                        {% set subtitle = entry.episode_title %}
                    {% endif %}
                {% endif %}
                {% if entry.mirror_info %}
                    {% if subtitle %}
                        {% set subtitle = subtitle ~ ' · ' ~ entry.mirror_info %}
                    {% else %}
                        {% set subtitle = entry.mirror_info %}
                    {% endif %}
                {% endif %}
            {% else %}
                {% if entry.mirror_info %}
                    {% set subtitle = entry.mirror_info %}
                {% else %}
                    {% set subtitle = 'Mirror' %}
                {% endif %}
            {% endif %}
            <li
                class="scraper-result"
                role="button"
                tabindex="0"
                data-content-type="{{ entry.content_type }}"
                {% if is_series and series %}
                    data-series-id="{{ series.id }}"
                {% elif movie %}
                    data-movie-id="{{ movie.id }}"
                {% endif %}
            >
                <div class="scraper-result__meta">
                    <span class="scraper-result__source">
                        {{ entry.source_name }} · {{ 'Serie' if is_series else 'Film' }}
                    </span>
                    <h4>
                        {% if is_series and series %}
                            {{ series.name }}
                        {% elif movie %}
                            {{ movie.title }}
                        {% else %}
                            Unbekannter Titel
                        {% endif %}
                    </h4>
                    {% if subtitle %}
                        <p>{{ subtitle }}</p>
                    {% endif %}
                </div>
                <button
                    type="button"
                    class="chip view-detail"
                    {% if is_series and series %}
                        data-series-id="{{ series.id }}"
                    {% elif movie %}
                        data-movie-id="{{ movie.id }}"
                    {% endif %}
                >
                    <span class="material-symbols-outlined" aria-hidden="true">open_in_new</span>
                    <span>Details</span>
                </button>
            </li>
        {% endfor %}
    </ul>
    {% else %}
        <p class="empty large">Noch keine gescrapten Links vorhanden.</p>
    {% endif %}
</section>
{% endblock %}
