<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}{{ page_title or 'Medusa ‚Äì Media Server' }}{% endblock %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Manrope:wght@400;500;600;700&display=swap"
    />
    <link
        rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,500,0,0"
    />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}" />
</head>
<body data-current-page="{{ active_page|default('start') }}" data-load-all-movies="{{ 'true' if load_all_movies|default(False) else 'false' }}">
    <div class="page-shell">
        <header class="topbar">
            <div class="topbar__brand">
                <div class="brand-logo" aria-hidden="true">üúÅ</div>
                <div class="brand-text">
                    <span class="brand-text__title">Medusa</span>
                    <span class="brand-text__subtitle">Streaming Hub</span>
                </div>
            </div>
            <nav class="topbar__nav" aria-label="Hauptnavigation">
                <a href="{{ url_for('index') }}" class="nav-link{% if active_page == 'start' %} is-active{% endif %}" data-navigation="route">
                    <span class="material-symbols-outlined" aria-hidden="true">home</span>
                    <span>Startseite</span>
                </a>
                <a href="{{ url_for('filme') }}" class="nav-link{% if active_page == 'filme' %} is-active{% endif %}" data-navigation="route">
                    <span class="material-symbols-outlined" aria-hidden="true">movie</span>
                    <span>Filme</span>
                </a>
                <a href="{{ url_for('serien') }}" class="nav-link{% if active_page == 'serien' %} is-active{% endif %}" data-navigation="route">
                    <span class="material-symbols-outlined" aria-hidden="true">tv</span>
                    <span>Serien</span>
                </a>
                <a href="{{ url_for('scraper_view') }}" class="nav-link{% if active_page == 'scraper' %} is-active{% endif %}" data-navigation="route">
                    <span class="material-symbols-outlined" aria-hidden="true">link</span>
                    <span>Scraper</span>
                </a>
                <a href="{{ url_for('settings_view') }}" class="nav-link{% if active_page == 'settings' %} is-active{% endif %}" data-navigation="route">
                    <span class="material-symbols-outlined" aria-hidden="true">settings</span>
                    <span>Einstellungen</span>
                </a>
            </nav>
            <div class="topbar__actions">
                <form class="topbar-search" role="search">
                    <span class="material-symbols-outlined" aria-hidden="true">search</span>
                    <input type="search" name="q" placeholder="Bibliothek oder TMDB durchsuchen" autocomplete="off" />
                    <div
                        class="topbar-search__results"
                        id="topbarSearchResults"
                        aria-hidden="true"
                        data-poster-placeholder="{{ url_for('static', filename='images/poster-placeholder.svg') }}"
                    >
                        <ul class="topbar-search__list" id="topbarSearchList" role="listbox"></ul>
                    </div>
                </form>
                <button id="syncTmdb" class="icon-button" type="button" title="TMDB synchronisieren">
                    <span class="material-symbols-outlined" aria-hidden="true">sync</span>
                </button>
                <button id="scrapeAllScrapers" class="icon-button" type="button" title="Alle Scraper starten">
                    <span class="material-symbols-outlined" aria-hidden="true">cloud_download</span>
                </button>
                <button class="icon-button" type="button" title="Benachrichtigungen">
                    <span class="material-symbols-outlined" aria-hidden="true">notifications</span>
                </button>
                {% set latest_view = user_profile.recently_viewed|first if user_profile else None %}
                <div class="topbar__profile">
                    <a href="{{ url_for('profile_view') }}" class="topbar-profile__trigger" aria-label="Zum Benutzerprofil">
                        <div class="avatar topbar-profile__avatar" role="img" aria-label="Benutzerprofil">
                            {% if user_profile.avatar_image_url %}
                                <img src="{{ user_profile.avatar_image_url }}" alt="Profilbild" loading="lazy" />
                            {% else %}
                                <span>{{ user_profile.avatar_initials or '--' }}</span>
                            {% endif %}
                        </div>
                        <div class="topbar-profile__details">
                            <span class="topbar-profile__name">{{ user_profile.name or 'Profil' }}</span>
                            <span class="topbar-profile__meta">
                                {% if latest_view %}
                                    Zuletzt angesehen: {{ latest_view.title }}
                                {% else %}
                                    Zuletzt angesehen: Noch keine Inhalte
                                {% endif %}
                            </span>
                        </div>
                        <span class="material-symbols-outlined topbar-profile__chevron" aria-hidden="true">chevron_right</span>
                    </a>
                    <div class="topbar-profile__dropdown" role="menu" aria-label="Benutzeraktionen">
                        <div class="topbar-profile__header">
                            <div class="avatar topbar-profile__avatar topbar-profile__avatar--lg" aria-hidden="true">
                                {% if user_profile.avatar_image_url %}
                                    <img src="{{ user_profile.avatar_image_url }}" alt="Profilbild" loading="lazy" />
                                {% else %}
                                    <span>{{ user_profile.avatar_initials or '--' }}</span>
                                {% endif %}
                            </div>
                            <div>
                                <p class="topbar-profile__welcome">Hallo, {{ user_profile.name or 'Profil' }}</p>
                                <p class="topbar-profile__role">{{ user_profile.role or 'Keine Rolle angegeben' }}</p>
                                <p class="topbar-profile__since">Mitglied seit {{ user_profile.membership_since_display or 'Unbekannt' }}</p>
                            </div>
                        </div>
                        <div class="topbar-profile__recent">
                            <p class="topbar-profile__recent-title">Zuletzt angesehen</p>
                            <ul class="topbar-profile__recent-list">
                                {% for item in user_profile.recently_viewed[:4] %}
                                    {% set thumb = item.poster_url or item.backdrop_url %}
                                    <li class="topbar-profile__recent-item">
                                        <div
                                            class="topbar-profile__recent-thumb"
                                            style="--thumb-image: url('{{ thumb or url_for('static', filename='images/poster-placeholder.svg') }}');"
                                            aria-hidden="true"
                                        ></div>
                                        <div class="topbar-profile__recent-info">
                                            <span class="topbar-profile__recent-type">{{ item.category }}</span>
                                            <span class="topbar-profile__recent-title-text">{{ item.title }}</span>
                                            {% if item.parent_title %}
                                                <span class="topbar-profile__recent-subtitle">{{ item.parent_title }}</span>
                                            {% endif %}
                                            <span class="topbar-profile__recent-meta">{{ item.viewed_at_display }}</span>
                                        </div>
                                    </li>
                                {% else %}
                                    <li class="topbar-profile__recent-item topbar-profile__recent-item--empty">
                                        <span class="material-symbols-outlined" aria-hidden="true">hourglass_empty</span>
                                        <span>Noch keine Inhalte angesehen</span>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                        <a class="topbar-profile__link" href="{{ url_for('profile_view') }}">
                            <span class="material-symbols-outlined" aria-hidden="true">account_circle</span>
                            <span>Profil √∂ffnen</span>
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <main class="page-content">
            {% block preface %}{% endblock %}
            {% block main %}{% endblock %}
        </main>

        <div
            class="search-overlay"
            id="searchOverlay"
            role="dialog"
            aria-modal="true"
            aria-labelledby="searchOverlayTitle"
            aria-hidden="true"
        >
            <div class="search-overlay__container">
                <header class="search-overlay__head">
                    <div>
                        <span class="chip chip--accent search-overlay__chip">Suche</span>
                        <h2 id="searchOverlayTitle" class="search-overlay__title">Suchergebnisse</h2>
                        <p id="searchOverlayMeta" class="search-overlay__meta"></p>
                    </div>
                    <button
                        type="button"
                        id="searchOverlayClose"
                        class="icon-button search-overlay__close"
                        aria-label="Suchergebnisse schlie√üen"
                    >
                        <span class="material-symbols-outlined" aria-hidden="true">close</span>
                    </button>
                </header>
                <div class="search-overlay__body">
                    <div id="searchOverlayList" class="media-grid search-overlay__grid" role="list"></div>
                    <div id="searchOverlayEmpty" class="search-overlay__empty" role="status" hidden></div>
                </div>
            </div>
        </div>
    </div>

    {% if show_detail_panel %}
        {% include 'partials/detail_panel.html' %}
        {% include 'partials/trailer_modal.html' %}
    {% endif %}

    <div class="toast" id="toast" role="status" aria-live="polite"></div>
    <script src="{{ url_for('static', filename='js/main.js') }}" defer></script>
</body>
</html>
